<html>
 <head></head> 
 <body> 
  <div class="entry"> 
   <p>将web页面上显示的报表导出到excel文件里是一种很常见的需求。润乾报表的类excel模型，支持excel文件数据无失真的导入导出，使用起来非常的方便。然而，当数据量较大的情况下，excel本身的支持最多65535行数据的问题便凸显出来。下面就给出大数据量导出到excel的解决方案。</p> 
   <p>首先，对于数据超过了65535行的问题，很自然的就会想到将整个数据分块，利用excel的多sheet页的功能，将超出65535行后的数据写入到下一个sheet页中，即通过多sheet页的方式，突破了最高65535行数据的限定。</p> 
   <p>具体做法就是，单独做一个链接，使用JSP导出，在JSP上通过程序判断报表行数，超过65535行后分SHEET写入。这样这个问题就得以解决了。</p> 
   <p>更进一步地说，在这种大数据量的报表生成和导出中，要占用大量的内存，尤其是在使用TOMCAT的情况下，JVM最高只能支持到2G内存，则会发生内存溢出的情况。此时的内存开销主要是两部分，一部分是该报表生成时的开销，另一部分是该报表生成后写入一个EXCEL时的开销。由于JVM的GC机制是不能强制回收的，因此，对于此种情形，我们给出一个变通的解决方案。</p> 
   <p>首先，将该报表设置起始行和结束行参数，在API生成报表的过程中，分步计算报表，比如一张20万行数据的报表，在生成过程中，可通过起始行和结束行分4-5次进行。这样，就降低了报表生成时的内存占用，在后面报表生成的过程中，如果发现内存不够，即可自动启动JVM的GC机制，回收前面报表的缓存。</p> 
   <p>导出EXCEL的过程，放在每段生成报表之后立即进行，改多个SHEET页为多个EXCEL，即在分步生成报表的同时分步生成EXCEL，则通过POI包生成EXCEL的内存消耗也得以降低。通过多次生成，同样可以在后面EXCEL生成所需要的内存不足时，有效回收前面生成EXCEL时占用的内存。</p> 
   <p>再使用文件操作，对每个客户端的导出请求在服务器端根据SESSIONID和登陆时间生成唯一的临时目录，用来放置所生成的多个EXCEL，然后调用系统控制台，打包多个EXCEL为RAR或者JAR方式，最终反馈给用户一个RAR包或者JAR包，响应客户请求后，再次调用控制台删除该临时目录。</p> 
   <p>使用这种方法，首先是通过分段运算和生成，有效降低了报表从生成结果到生成EXCEL的内存开销。其次是通过使用压缩包，响应给用户的生成文件体积大大缩小，降低了多用户并发访问时服务器下载文件的负担，有效减少多个用户导出下载时服务器端的流量，从而达到进一步减轻服务器负载的效果。</p> 
  </div>  
 </body>
</html>